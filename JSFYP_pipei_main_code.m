clc;clear
%%
fid='test_data_near_field\' %A floder with data
filename=dir([fid,'*.AT2']);



TS=[0.01,0.02,0.03,0.04,0.05,0.08,0.1,0.12,0.15,0.2,0.25,0.3,0.35,0.4,0.45,0.5,0.6,0.7,0.8,0.9,1,1.5,2,2.5,3,4,5,6,8,10];

%% The target spectrum is calculated and plotted
load ZYX.mat % Information about selected ground motions
NN=9000; %
for ii2=[0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1.0,1.1,1.2,1.3,1.4,1.5]%1:34
    ii3=ii2
    mkdir(['Sa0.5s\',num2str(ii3),'g\'])
    fid1=['Sa0.5s\',num2str(ii3),'g\']
    
    for ii1=1:length(filename)
        
        TS=[0.01,0.02,0.03,0.04,0.05,0.08,0.1,0.12,0.15,0.2,0.25,0.3,0.35,0.4,0.45,0.5,0.6,0.7,0.8,0.9,1,1.5,2,2.5,3,4,5,6,8,10];
        [info,Data] =readfile_NGA([fid,'\',filename(ii1).name]);
        bl=zeros(NN,1)
        Data=[bl;Data]
        dt=info.dt
        Data=Data.*980;
        aaa=strrep(filename(ii1).name,'RSN','');
        record_number=sscanf(aaa,'%g');
        %     record_number_1(ii1)=record_number
        WZ1=find(ZYX(:,1)==record_number)
        
        %% define Sa
        Sa=ii3; %调节幅值
        %%
        Rjb=ZYX(WZ1,3)
        Fault_Type=0
        
        region=1
        z1=999
        Vs30=ZYX(WZ1,4)
        T=[0.0100000000000000,0.0200000000000000,0.0220000000000000,0.0250000000000000,0.0290000000000000,0.0300000000000000,0.0320000000000000,0.0350000000000000,0.0360000000000000,0.0400000000000000,0.0420000000000000,0.0440000000000000,0.0450000000000000,0.0460000000000000,0.0480000000000000,0.0500000000000000,0.0550000000000000,0.0600000000000000,0.0650000000000000,0.0670000000000000,0.0700000000000000,0.0750000000000000,0.0800000000000000,0.0850000000000000,0.0900000000000000,0.0950000000000000,0.100000000000000,0.110000000000000,0.120000000000000,0.130000000000000,0.133000000000000,0.140000000000000,0.150000000000000,0.160000000000000,0.170000000000000,0.180000000000000,0.190000000000000,0.200000000000000,0.220000000000000,0.240000000000000,0.250000000000000,0.260000000000000,0.280000000000000,0.290000000000000,0.300000000000000,0.320000000000000,0.340000000000000,0.350000000000000,0.360000000000000,0.380000000000000,0.400000000000000,0.420000000000000,0.440000000000000,0.450000000000000,0.460000000000000,0.480000000000000,0.500000000000000,0.550000000000000,0.600000000000000,0.650000000000000,0.667000000000000,0.700000000000000,0.750000000000000,0.800000000000000,0.850000000000000,0.900000000000000,0.950000000000000,1,1.10000000000000,1.20000000000000,1.30000000000000,1.40000000000000,1.50000000000000,1.60000000000000,1.70000000000000,1.80000000000000,1.90000000000000,2,2.20000000000000,2.40000000000000,2.50000000000000,2.60000000000000,2.80000000000000,3,3.20000000000000,3.40000000000000,3.50000000000000,3.60000000000000,3.80000000000000,4,4.20000000000000,4.40000000000000,4.60000000000000,4.80000000000000,5,5.50000000000000,6,6.50000000000000,7,7.50000000000000,8,8.50000000000000,9,9.50000000000000,10]
        
%%


Mw=ZYX(WZ1,2);

% region=1
% z1=999
% Vs30=360
T1=0.5; %Tcond

k=1; % one standard
        
        %% solve Mw ---68 means T=1s
        e1=30;e2=-20; TTT=16
        e3=(e1+e2)/2;[c, period1] = CMS_IDA(Mw, T, Rjb, Fault_Type, region, z1, Vs30,T1,e3,k);C=c(TTT);
        while abs(C-Sa)>0.000001
            if C>Sa
                e1=e3;
            elseif C<Sa
                e2=e3;
            end
            e3=(e1+e2)/2;[c, period1] = CMS_IDA(Mw, T, Rjb, Fault_Type, region, z1, Vs30,T1,e3,k);C=c(TTT);
        end
        e=e3;
        %%
        [median, period1] =CMS_IDA(Mw, T, Rjb, Fault_Type, region, z1, Vs30,T1,e,k);
        
        
        WZ=[1,2,6,10,16,23,27,29,33,38,41,45,48,51,54,57,59,62,64,66,68,73,78,81,84,90,95,97,101,105]
        M=[median(WZ).*980];
        
        d=0.05;ss=20;maxgen=5;sizepop=12;n=2;o=1;
        
        t1=clock;
        [Data2]=SpectralMatching(Data,dt,TS,M,d,ss,maxgen,sizepop,n,o);
        t2=clock;
        disp(etime(t2,t1))
        dT=dt;acc=Data2;
        %[acc_correction,vel_correction,dis_correction]=Baseline_correction_JK_change(dT,acc);
        fBPA=fopen([fid1,filename(ii1).name,'.txt'],'w');
        fprintf(fBPA,'%8.10f\r\n',Data2(9001:end)./980);
        fclose(fBPA);
    end
end
